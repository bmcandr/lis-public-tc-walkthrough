== {title-step1}

:step-label: Step 1

:download-filename: testcase1_ldt_parms.tgz
:input-filesize-compressed: 350MB
:input-filesize-unpacked: 4.1GB
:ldt-run-dir:
:ldt-config-filename: ldt.config.noah36_params

:url-domain-geojson: https://github.com/bmcandr/lis-public-testcases/blob/master/guide/domain.geojson

=== Overview

In this step you will learn how to run LDT to perform parameter processing for the Noah-3.6 land surface model (LSM) and generate a Noah-3.6 parameter input file to be used by LIS (and LVT) in later steps.

NOTE: These testcases were designed to be run in sequential order and later steps require the output generated by earlier steps.

==== Steps to Running LDT

. Compile the LDT source code to generate the LDT executable (see <<_setup>>)
. Collect input data needed by LDT
. Modify `ldt.config` file to define runtime configuration settings
. Run the LDT executable
. Examine output

[#download-step-1]
include::download_input_files.adoc[]

In addition to the `LISF/` directory and the three executables, your `$WORKING_DIR` should now contain the following directory and files:

[cols="2*",frame=topbot,stripes=odd]
[%autowidth]
|===
|`INPUT/` |A directory that will hold parameter and input files needed throughout the testcases
|`{ldt-config-filename}` |The runtime configuration file read by LDT in this step
|`target_lis_input.nldas.noah36.d01.nc` |The "target" NetCDF file generated by LDT in this step
|`target_MaskParamFill.log` |The "target" mask-parameter log generated by LDT in this step
|===

Each of the files beginning with `target` are provided to compare with the output of your run. Use command-line tools such as `diff` and `nccmp` for these comparisons.

==== The LDT Configuration File

The LDT configuration file (`{ldt-config-filename}`) contains input settings used by LDT at run-time to generate input files for LIS. The configuration options are described in depth in the {url-lis-official-docs}[official documentation,window=_blank].

Before continuing, review the contents of the LDT configuration file for our LDT-based Noah.3.6 parameter test case by printing the file contents to the terminal with `cat` or opening the file with a text editor such as `vim` or `emacs`. Key elements of the file are highlighted below:

[#cat-ldt-config]
[source,shell]
----
#Overall driver options
LDT running mode:                              "LSM parameter processing"
Processed LSM parameter filename:              ./lis_input.nldas.noah36.d01.nc # <1>
LIS number of nests:                           1
Number of surface model types:                 2
Surface model types:                           "LSM" "Openwater"
Land surface model:                            "Noah.3.6" <2>
Lake model:                                     none
Water fraction cutoff value:                    0.5

Number of met forcing sources:                  0
Met forcing sources:                            "NLDAS2"
Met spatial transform methods:                  "neighbor"  # bilinear
Topographic correction method (met forcing):    "lapse-rate"
Temporal interpolation method (met forcing):    linear
LDT diagnostic file:                            ldtlog <3>
LDT output directory:                           OUTPUT <4>
Undefined value:                                -9999.0
# ...
#LIS domain <5>
Map projection of the LIS domain:               latlon
Run domain lower left lat:                      34.375
Run domain lower left lon:                      -102.875
Run domain upper right lat:                     39.625
Run domain upper right lon:                     -96.125
Run domain resolution (dx):                     0.25
Run domain resolution (dy):                     0.25

# Parameters
Landcover data source:                          MODIS_Native <6>
Landcover classification:                       IGBPNCEP
Landcover file:                                 ./INPUT/LS_PARAMETERS/noah_2dparms/igbp.bin <6>
Landcover spatial transform:                    tile
Landcover fill option:                          none # Set to none if creating land mask
Landcover map projection:                       latlon
# ...
----
<1> The name of the NetCDF-formatted parameter file to be generated which will be used by LIS
<2> The LSM of interest (e.g., https://ral.ucar.edu/solutions/products/noah-multiparameterization-land-surface-model-noah-mp-lsm[Noah.3.6])
<3> The name of the diagnostic log file
<4> The directory where LDT output will be placed
<5> The grid projection, domain extents, and spatial resolution to be used by LIS (and LVT)
<6> Data source settings and paths (e.g., landcover datasets, elevation datasets) and additional features of interest (e.g., irrigation settings)

Make sure the desired options are selected for the Noah.3.6 model and that filepaths correctly point to the local `INPUT/` directory in your `$WORKING_DIR` (i.e., paths should begin `./INPUT`).

===== Noah Land Surface Model Parameters

As you may have noticed, these testcases utilize NOAA/NCAR's Noah LSM, v3.6. The input parameters selected in `{ldt-config-filename}` include:

[cols="2*",options=header,frame=topbot,stripes=odd]
[%autowidth]
|===
|Parameter |Dataset
|Landcover |MODIS-based IGBP landcover map (~ 1 km, NOAA)
|Soil texture |FAO+STATSGOv1 combined soil texture map (~ 1 km, NOAA)
|Greenness fraction |AVHRR-based monthly climatology (1.0 deg, NOAA)
|Snow-free albedo |Monthly climatology dataset (1.0 deg, NOAA)
|Maximum snow albedo |MODIS-based maximum snow albedo (0.05 deg; Mike Barlage, NCAR)
|Bottom of soil column temperature |ISLSCP-1 climatology dataset (1.0 deg)
|===

===== Testcase Domain

The spatial domain defined in the LDT configuration file will be placed in `lis_input.nldas.noah36.d01.nc`, the NetCDF-formatted parameter file generated by LDT which LIS will read in automatically at run-time. For these testcases we will be using the domain depicted by the black box on this map:

[.float-group]
--
.Testcase domain ({url-domain-geojson}[geojson])
image::step_1_domain_radar.jpeg[align=center]
--

=== Running LDT - The Parameter Processing Step

include::running_ldt.adoc[]

If `ldtlog.0000` ends with the above message, the run completed successfully. Run `ls` in the terminal to see the new files created by LDT. In particular, verify that the LIS input file `lis_input.nldas.noah36.d01.nc` was produced.

=== LDT Output Files

The following files are typically generated by an LDT parameter processing run:

[cols="2*",frame=topbot,stripes=odd]
[%autowidth]
|===
|`lis_input.d01.nc` |The NetCDF-formatted model parameter file which LIS reads at runtime. `d01` refers to the indexed domain, typically used as "nests" for NASA-Unified WRF simulations.
|`lislog.0000` |The runtime configuration file read by LDT in this stepThe output diagnostic file that provides runtime messages, including warnings and error messages. This file is useful for verifying successful run completion and troubleshooting unsuccessful runs.
|`MaskParamFill.log` |The "target" NetCDF file generated by LDT in this stepThis diagnostic file informs of any disagreements between an LSM-based parameter and the landmask, and whether any parameter gridcells were "filled" to agree with the landmask.
|===

NOTE: The output filenames for `lis_input.d01.nc` and `ldtlog.0000` can be defined in the `ldt.config` file, but the filename of `MaskParamFill.log` cannot be modified.

===== The LIS Configuration File

The contents of the LIS input file produced by LDT can be examined visually using a command-line program such as http://meteora.ucsd.edu/~pierce/ncview_home_page.html[`ncview`,window=_blank] or a desktop application like NASA's https://www.giss.nasa.gov/tools/panoply/[Panoply,window=_blank]. For this walkthrough we will be using `ncview`.

Open the LIS input file using `ncview`:

[source,shell]
----
% ncview lis_input.nldas.noah36.d01.nc
----

In the `ncview` window that opens, click on the widget labeled *DOMAINMASK*. A second window will open containing a map of the mask. The domain we are using is a simple rectangle so, as expected, all values are equal to `1`.

Click on the widget labeled *LANDMASK*. Again, the values are all equal to `1`. This indicates that all grid cells within the domain are treated as land and, as a result, the input file should _not_ contain any undefined values (e.g., `-9999`).

.LANDMASK dataset
image::step_1_landmask.png[]

Click on the *LANDCOVER* widget to view the landcover variable. In the bottom third of the `ncview` window, click on the widget below the label _Current_ to cycle through th 20 different http://www.eomf.ou.edu/static/IGBP.pdf[IGBP landcover and land use classes]. In the screenshot below the _Crop_ class is selected (the classes are zero-indexed in `ncview`; add 1 to index to convert to IGBP class).

.The _Crop_ class of the *LANDCOVER* dataset
image::step_1_landcover.png[]

Click on the *TEXTURE* widget to view the soil texture dataset. Click on the widget below the label _Current_. This is the FAO+STATSGO soil texture map, aggregated using the `tile` option for the `Soil texture spatial transform:` setting in `ldt.config`. The map shows the fraction, or frequencies, of each soil type within each 0.25° degree grid cell of our domain.

.Soil texture, tile-based aggregation
image::step_1_soil_texture_tile.png[]

LDT provides several other options for grid cell aggregation including `none`, `mode`, and `neighbor`. What would the output look like if we were to rerun LDT after switching from `tile` to `mode`? Open `ldt.config.noah36_params` in a text editor and change the `Soil texture spatial transform` option from `tile` to `mode` as below:

[source,shell]
----
...
Soil texture spatial transform: mode
...
----

Rerun LDT:

[source,shell]
----
% ./LDT ldt.config.noah36_params
----

Check the end of `ldtlog.0000` to verify LDT ran successfully. Again, open the LIS input file using `ncview` and click on the *TEXTURE* widget.

image::step_1_soil_texture_mode.png[]

Each soil type now shows a total value of 1 within each 0.25 degree grid cell of our domain. Why? The `mode` option selects the _dominant_ soil type for each grid cell.

For comparison:

.Dominant vs. fractional soil type
image::step_1_soil_texture_comparison.png[]

Another program called `ncdump` can be used to directly view the datasets contained in NetCDF files. For example, the `-h` flag can be used to print the dimensions, variable names, and attributes of the file to the terminal:

[source,shell]
----
% ncdump -h lis_input.nldas.noah36.d01.nc
netcdf lis_input.nldas.noah36.d01 {
dimensions:
    east_west = 28 ;
    north_south = 22 ;
    east_west_b = 32 ;
    north_south_b = 26 ;
    month = 12 ;
    time = 1 ;
    sfctypes = 21 ;          # Note: 21 includes “openwater” surface type
    soiltypes = 16 ;
    elevbins = 1 ;
    slopebins = 1 ;
    aspectbins = 1 ;
variables:
    float time(time) ;
    float DOMAINMASK(north_south, east_west) ;
          DOMAINMASK:standard_name = "DOMAINMASK" ;
          DOMAINMASK:units = "" ;
          DOMAINMASK:scale_factor = 1.f ;
          DOMAINMASK:add_offset = 0.f ;
          DOMAINMASK:missing_value = -9999.f;
          DOMAINMASK:vmin = 0.f ;
          DOMAINMASK:vmax = 0.f ;
          DOMAINMASK:num_bins = 1 ;
global attributes:
    :MAP_PROJECTION = "EQUIDISTANT CYLINDRICAL" ;
    :SOUTH_WEST_CORNER_LAT = 34.375f ;
    :SOUTH_WEST_CORNER_LON = -102.875f ;
    :DX = 0.25f ;
    :DY = 0.25f ;
    :INC_WATER_PTS = "true" ;
    :LANDCOVER_SCHEME = "IGBPNCEP" ;
    :BARESOILCLASS = 16 ;
    :URBANCLASS = 13 ;
    :SNOWCLASS = 15 ;
    :WATERCLASS = 17 ;
    :WETLANDCLASS = 11 ;
    :GLACIERCLASS = 15 ;
    :NUMVEGTYPES = 17 ;
    :LANDMASK_SOURCE = "MODIS_Native" ;
    :SFCMODELS = "Noah.3.6+Openwater" ;
    :SOILTEXT_SCHEME = "STATSGO" ;
    :GREENNESS_DATA_INTERVAL = "monthly" ;
    :ALBEDO_DATA_INTERVAL = "monthly" ;
----

===== Comparing Output

To further confirm that LDT ran successfully, you can compare your output with the "target" output included in the input files you downloaded earlier (files or directories beginning with `target_`). For example, use https://gitlab.com/remikz/nccmp[`nccmp`] to compare your `lis_input.nldas.noah36.d01.nc` with `target_lis_input.nldas.noah36.d01.nc`:

[source,shell]
----
% nccmp -mdfs lis_input.nldas.noah36.d01.nc target_lis_input.nldas.noah36.d01.nc
----

Where the flags enable the following options:

* `m`: compare metadata
* `d`: compare data
* `f`: force comparison to continue after differences found
* `s`: report identical files to terminal (by default `nccmp` runs silently if files are identical)

NOTE: Some files may not be identical, but any differences reported should be small.

=== Wrap-up

The LDT parameter processing run generates input parameters and files that LIS requires. Your `$WORKING_DIR` should now contain all the files needed to continue on to <<{title-step2}>>.